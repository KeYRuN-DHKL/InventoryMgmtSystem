@model InventoryMgmtSystem.Models.SalesVm

@{
    ViewBag.Title = "title";
    Layout = "_Layout";
}

<form method="post">
    <label class="h4 mb-3">Create Sales</label>
    <div>
        <div class="d-flex mb-2">
            <label asp-for="InvoiceNo" class="me-2">Invoice No</label>
            <input type="text" asp-for="InvoiceNo" readonly/>
        </div>
        <div class="mb-2">
            <label asp-for="StakeHolderId" class="me-2">StakeHolder</label>
            <select asp-for="StakeHolderId" asp-items="Model.StakeHolders" required>
                <option value="">Select</option>
            </select>
        </div>
        <div class="mb-2">
            <label asp-for="Tdate" class="me-2">Date</label>
            <input type="date" asp-for="Tdate" />
        </div>
    </div>

    <table class="table table-bordered" id="salesTable">
        <thead>
        <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Rate</th>
            <th>Amount</th>
            <th>Vat (%)</th>
            <th>Vat Amount</th>
            <th>Total</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>
                <select asp-for="StockMovement[0].ProductId" asp-items="Model.Products" class="form-select" required>
                    <option value="">Select</option>
                </select>
            </td>
            <td>
                <input type="number" asp-for="StockMovement[0].Quantity" class="form-control qty" min="0.1" step="0.1" required />
            </td>
            <td>
                <input type="number" asp-for="StockMovement[0].Rate" class="form-control rate" min="0" step="0.01" required />
            </td>
            <td>
                <input type="number" class="form-control amount" readonly />
            </td>
            <td>
                <input type="number" asp-for="StockMovement[0].VatPer" class="form-control vatper" min="0" step="0.01" required />
            </td>
            <td>
                <input type="number" class="form-control vatamt" readonly />
            </td>
            <td>
                <input type="number" class="form-control total" readonly />
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm removeRow">X</button>
            </td>
        </tr>
        </tbody>
    </table>

    <button type="button" id="addRow" class="btn btn-primary btn-sm">+ Add Row</button>

    <div class="mt-3 row g-2">
        <div class="col">
            <label>Total Amount</label>
            <input type="number" asp-for="Amount" id="totalAmount" class="form-control" readonly />
        </div>
        <div class="col">
            <label>Taxable Amount</label>
            <input type="number" asp-for="TaxableAmount" id="taxableAmount" class="form-control" readonly />
        </div>
        <div class="col">
            <label>Tax Amount</label>
            <input type="number" asp-for="TaxAmount" id="taxAmount" class="form-control" readonly />
        </div>
        <div class="col">
            <label>Grand Total</label>
            <input type="number" id="grandTotal" class="form-control" readonly />
        </div>
    </div>

    <div class="mt-3">
        <label asp-for="Remark"></label>
        <input asp-for="Remark" class="form-control" />
    </div>
    <button type="submit"> Submit</button>
</form>

@section Scripts {
    <script>
        function recalcRow(row) {
            let qty = parseFloat(row.find(".qty").val()) || 0;
            let rate = parseFloat(row.find(".rate").val()) || 0;
            let vatPer = parseFloat(row.find(".vatper").val()) || 0;

            let amount = qty * rate;
            let vatAmt = (amount * vatPer) / 100;
            let total = amount + vatAmt;

            row.find(".amount").val(amount.toFixed(2));
            row.find(".vatamt").val(vatAmt.toFixed(2));
            row.find(".total").val(total.toFixed(2));

            recalcTotals();
        }
        function reindexRows() {
            $("#salesTable tbody tr").each(function (rowIndex) {
                $(this).find("input, select").each(function () {
                    let name = $(this).attr("name");
                    if (name) {
                        $(this).attr("name", name.replace(/\[\d+\]/, "[" + rowIndex + "]"));
                    }
                });
            });
        }

        function recalcTotals() {
            let totalAmt = 0, taxableAmt = 0, taxAmt = 0, grandTotal = 0;

            $("#salesTable tbody tr").each(function () {
                let amount = parseFloat($(this).find(".amount").val()) || 0;
                let vatAmt = parseFloat($(this).find(".vatamt").val()) || 0;
                let total = parseFloat($(this).find(".total").val()) || 0;

                totalAmt += amount;
                taxableAmt += amount;
                taxAmt += vatAmt;
                grandTotal += total;
            });

            $("#totalAmount").val(totalAmt.toFixed(2));
            $("#taxableAmount").val(taxableAmt.toFixed(2));
            $("#taxAmount").val(taxAmt.toFixed(2));
            $("#grandTotal").val(grandTotal.toFixed(2));
        }

        $(document).on("input", ".qty, .rate, .vatper", function () {
            recalcRow($(this).closest("tr"));
        });

        $("#addRow").click(function () {
            let rowCount = $("#salesTable tbody tr").length;
            let newRow = $("#salesTable tbody tr:first").clone();

            newRow.find("input, select").each(function () {
                let name = $(this).attr("name");
                if (name) {
                    $(this).attr("name", name.replace(/\[\d+\]/, "[" + rowCount + "]"));
                }
                $(this).val("");
            });

            $("#salesTable tbody").append(newRow);
            reindexRows();
        });

        $(document).on("click", ".removeRow", function () {
            if ($("#salesTable tbody tr").length > 1) {
                $(this).closest("tr").remove();
                reindexRows();
                recalcTotals();
            }
        });
    </script>
}

